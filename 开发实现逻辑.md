# 易损清单生成工具 - 开发实现逻辑

## 1. 项目概述

易损清单生成工具是一个基于Electron开发的桌面应用，用于从Excel文件中自动识别和生成易损设备清单。该工具结合了预设的设备清单和人工确认，确保易损设备的准确性和完整性。

## 2. 技术栈

- **前端框架**：HTML/CSS/JavaScript
- **桌面应用框架**：Electron
- **数据处理**：xlsx-js-style
- **数据库**：MySQL
- **依赖管理**：npm

## 3. 核心功能

1. **设备清单管理**：添加、删除、修改设备信息，支持批量导入
2. **Excel文件处理**：读取和解析Excel文件，提取设备信息
3. **易损设备自动识别**：基于预设的设备清单自动识别易损设备
4. **未识别设备人工确认**：允许用户手动确认未识别设备的易损状态
5. **易损清单生成与导出**：生成符合格式要求的Excel文件
6. **数据去重**：按机型+ERP编号组合去重

## 4. 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Excel文件      │────▶│   设备匹配引擎    │────▶│   易损清单结果   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              ▲                         ▲
                              │                         │
                              │                         │
                        ┌─────────────────┐     ┌─────────────────┐
                        │   设备清单数据库   │     │   Excel导出模块   │
                        └─────────────────┘     └─────────────────┘
```

## 5. 易损设备判断核心流程

### 5.1 文件处理与机型获取

```javascript
// 根据文件名获取机型
let model = '';
if (fileName.includes('摆渡车')) {
    model = '摆渡车';
} else if (fileName.includes('运输车')) {
    model = '运输车';
} else if (fileName.includes('砖机')) {
    model = '砖机';
} else if (fileName.includes('辅机')) {
    model = '辅机';
}
```

### 5.2 复合键生成

```javascript
// 生成复合键：ERP编号|机型
const compositeKey = `${materialId}|${model}`;
```

### 5.3 设备匹配逻辑

```javascript
// 使用复合键查找设备
const device = devices.get(compositeKey);

if (device) {
    // 复合键匹配成功
    if (device.status === '黑名单') {
        // 第一步：检查黑名单（优先级更高）
        fileResults.matchedBlack++;
    } else if (device.status === '白名单') {
        // 第二步：检查白名单
        fileResults.vulnerable.push(device);
        fileResults.matchedWhite++;
    }
} else {
    // 复合键匹配失败
    // 检查是否存在相同ERP编号但不同机型的设备
    let hasDifferentModel = false;
    for (const [key, dev] of devices.entries()) {
        if (dev.materialId === materialId && dev.model !== model) {
            hasDifferentModel = true;
            break;
        }
    }
    
    if (hasDifferentModel) {
        // 存在相同ERP编号但不同机型 → 标记为匹配黑名单
        fileResults.matchedBlack++;
    } else {
        // 完全未匹配 → 加入未识别设备列表
        fileResults.unknown.push(device);
        fileResults.unmatched++;
    }
}
```

## 6. 匹配规则

| 匹配情况 | ERP编号 | 机型 | 处理方式 |
|---------|---------|------|----------|
| ✅ 完全匹配 | 匹配 | 匹配 | 检查黑白名单 |
| ❌ 复合键不匹配 | 匹配 | 不匹配 | 标记为匹配黑名单 |
| ❌ 完全不匹配 | 不匹配 | 不匹配 | 进入人工判断 |

## 7. 去重逻辑

### 7.1 去重函数

```javascript
// 支持单键或多键组合去重
function uniqueByKey(arr, keys) {
    const seen = new Set();
    return arr.filter(item => {
        const keyValue = Array.isArray(keys) 
            ? keys.map(key => item[key]).join('|') 
            : item[keys];
        
        if (seen.has(keyValue)) {
            return false;
        }
        seen.add(keyValue);
        return true;
    });
}
```

### 7.2 去重使用

```javascript
// 按机型+ERP编号组合去重
unknownDevices = uniqueByKey(unknownDevices, ['model', 'erpCode']);
vulnerableList = uniqueByKey(vulnerableList, ['model', 'erpCode']);
```

## 8. 未识别设备人工确认

### 8.1 验证逻辑

```javascript
// 对选择"是"的设备进行严格验证
if (isVulnerable) {
    if (!description) {
        alert(`第${i+1}行：物料描述不能为空`);
        return;
    }
    if (spareCount <= 0) {
        alert(`第${i+1}行：备件数必须大于0`);
        return;
    }
    if (!unit) {
        alert(`第${i+1}行：单位不能为空`);
        return;
    }
    if (!model) {
        alert(`第${i+1}行：机型不能为空`);
        return;
    }
}
```

### 8.2 状态保存

```javascript
// 选择"是" → 白名单
// 选择"否" → 黑名单
const deviceObj = {
    materialId,
    description,
    status: isVulnerable ? '白名单' : '黑名单'
};
```

## 9. Excel导出功能

### 9.1 导出格式

- **标题行**："KDZC-XXXXXX项目名称易损件清单"（加粗、等线、14号、居中）
- **表头行**：序号、物料号、物料描述、机型、建议备件数量、单位、备注（居中、加粗、等线、11号）
- **数据行**：等线、11号
  - 序号、物料号、建议备件数量：靠右对齐
  - 物料描述、机型、单位、备注：靠左对齐

### 9.2 导出实现

```javascript
// 准备导出数据
const dataRows = vulnerableList.map((device, index) => [
    index + 1, // 序号
    device.erpCode, // 物料号
    device.description, // 物料描述
    device.model, // 机型
    device.spareCount, // 建议备件数量
    device.unit, // 单位
    device.remark // 备注
]);

// 创建包含标题和表头的完整数据
const exportData = [
    ['KDZC-XXXXXX项目名称易损件清单'], // 标题行
    ['序号', '物料号', '物料描述', '机型', '建议备件数量', '单位', '备注'], // 表头行
    ...dataRows // 数据行
];
```

## 10. 数据库设计

### 10.1 设备表结构

```sql
CREATE TABLE `devices` (
   `id` int NOT NULL AUTO_INCREMENT,
   `material_id` varchar(255) NOT NULL,
   `spare_count` int NULL DEFAULT 0,
   `unit` varchar(50) NULL DEFAULT NULL,
   `model` varchar(255) NULL DEFAULT NULL,
   `remark` text NULL,
   `description` text NULL COMMENT '物料描述',
   `status` enum('白名单','黑名单') NOT NULL,
   `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`) USING BTREE,
   INDEX `idx_material_id_status`(`material_id` ASC, `status` ASC) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 820 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic;
```

### 10.2 数据库操作

- **缓存机制**：设备清单缓存在内存中，减少数据库查询频率
- **连接池**：使用MySQL连接池，优化数据库连接管理
- **批量操作**：支持批量插入和更新，提高性能

## 11. 关键函数说明

### 11.1 `processFiles` - 处理Excel文件

- **功能**：读取和解析Excel文件，提取设备信息
- **参数**：无
- **返回值**：无
- **核心流程**：
  1. 选择项目文件夹
  2. 读取所有Excel文件
  3. 解析Excel文件，提取设备信息
  4. 调用设备匹配引擎
  5. 生成易损清单结果

### 11.2 `matchDevices` - 设备匹配引擎

- **功能**：根据预设的设备清单匹配设备
- **参数**：
  - `materialIdModelPairs`：物料编号和机型的组合数组
- **返回值**：
  - `matched`：匹配成功的设备Map
  - `unmatched`：匹配失败的设备数组

### 11.3 `confirmUnknownDevices` - 确认未识别设备

- **功能**：处理用户确认的未识别设备
- **参数**：无
- **返回值**：无
- **核心流程**：
  1. 读取用户输入的设备信息
  2. 验证必填字段
  3. 保存设备到数据库
  4. 更新易损清单结果

## 12. 部署和使用

### 12.1 环境要求

- Node.js 16+
- MySQL 5.7+

### 12.2 安装步骤

1. 克隆项目代码
2. 安装依赖：`npm install`
3. 配置数据库连接：修改`dbConfig.json`
4. 启动应用：`npm start`
5. 打包应用：`npx electron-packager . 易损清单生成工具 --platform=win32 --arch=x64 --out=dist --overwrite`

### 12.3 数据库初始化

1. 创建数据库
2. 执行设备表SQL脚本
3. 移除material_id唯一约束（如果存在）：
   ```sql
   ALTER TABLE devices DROP INDEX uk_material_id;
   ```

## 13. 开发流程

1. **需求分析**：明确易损设备的判断规则和导出格式
2. **设计阶段**：设计系统架构、数据库结构和核心流程
3. **开发阶段**：实现核心功能和界面
4. **测试阶段**：进行单元测试和集成测试
5. **部署阶段**：打包应用，准备发布
6. **维护阶段**：修复bug，优化功能

## 14. 代码优化建议

1. **并发处理**：使用Promise.all和批量处理优化Excel文件读取
2. **缓存机制**：设备清单缓存在内存中，减少数据库查询
3. **错误处理**：完善的错误捕获和提示机制
4. **用户体验**：友好的界面和操作流程
5. **代码结构**：模块化设计，提高代码可维护性

## 15. 未来扩展方向

1. **自动更新功能**：支持应用自动更新
2. **多语言支持**：支持中英文切换
3. **更丰富的设备分类**：支持更多设备类型和状态
4. **数据统计和分析**：提供设备统计和趋势分析
5. **云端同步**：支持设备清单的云端同步和备份

## 16. 结语

易损清单生成工具通过结合预设的设备清单和人工确认，实现了易损设备的准确识别和生成。该工具的核心在于严格的匹配规则和去重逻辑，确保了易损清单的准确性和完整性。随着功能的不断完善和优化，该工具将在设备管理和维护中发挥越来越重要的作用。
